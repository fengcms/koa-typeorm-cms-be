# Koa CMS 2025 - å†…å®¹ç®¡ç†ç³»ç»Ÿåç«¯

ä¸€ä¸ªåŸºäº **Koa.js** + **TypeORM** æ„å»ºçš„ç°ä»£åŒ–å†…å®¹ç®¡ç†ç³»ç»Ÿåç«¯ï¼Œæä¾›å®Œæ•´çš„å†…å®¹ç®¡ç†ã€ç”¨æˆ·ç®¡ç†ã€æƒé™æ§åˆ¶å’Œå›¾ç‰‡å¤„ç†åŠŸèƒ½ã€‚

## ğŸš€ é¡¹ç›®ç‰¹è‰²

### æ ¸å¿ƒæŠ€æœ¯æ ˆ
- **æ¡†æ¶**: Koa.js 3.0 - è½»é‡çº§ã€é«˜æ€§èƒ½çš„ Node.js Web æ¡†æ¶
- **ORM**: TypeORM 0.3.23 - å¼ºå¤§çš„ TypeScript ORM æ¡†æ¶
- **æ•°æ®åº“**: MySQL - ç¨³å®šå¯é çš„å…³ç³»å‹æ•°æ®åº“
- **è¯­è¨€**: TypeScript - ç±»å‹å®‰å…¨çš„ JavaScript è¶…é›†
- **è®¤è¯**: JWT + RSA åŠ å¯† - å®‰å…¨çš„èº«ä»½éªŒè¯æœºåˆ¶
- **å›¾ç‰‡å¤„ç†**: Sharp - é«˜æ€§èƒ½å›¾ç‰‡å¤„ç†åº“

### æ¶æ„ç‰¹ç‚¹
- **RESTful API è®¾è®¡** - æ ‡å‡†åŒ–çš„æ¥å£è§„èŒƒ
- **æ¨¡å—åŒ–æ¶æ„** - æ¸…æ™°çš„ä»£ç ç»„ç»‡ç»“æ„
- **ç±»å‹å®‰å…¨** - å®Œæ•´çš„ TypeScript ç±»å‹å®šä¹‰
- **è‡ªåŠ¨ç«¯å£æ£€æµ‹** - æ™ºèƒ½ç«¯å£å†²çªå¤„ç†
- **ç¯å¢ƒé…ç½®** - çµæ´»çš„ç¯å¢ƒå˜é‡ç®¡ç†
- **é”™è¯¯å¤„ç†** - ç»Ÿä¸€çš„é”™è¯¯å¤„ç†æœºåˆ¶
- **æ—¥å¿—è®°å½•** - å®Œå–„çš„è¯·æ±‚æ—¥å¿—ç³»ç»Ÿ

## ğŸ“ é¡¹ç›®ç»“æ„

```
src/
â”œâ”€â”€ api/                    # API æ¥å£å±‚
â”‚   â”œâ”€â”€ extra/             # æ‰©å±• API æ¥å£
â”‚   â””â”€â”€ restful/           # RESTful API æ¥å£
â”œâ”€â”€ config/                # é…ç½®æ–‡ä»¶
â”‚   â”œâ”€â”€ index.ts          # ä¸»é…ç½®æ–‡ä»¶
â”‚   â”œâ”€â”€ key/              # RSA å¯†é’¥å­˜å‚¨
â”‚   â”œâ”€â”€ koaBody.ts        # è¯·æ±‚ä½“è§£æé…ç½®
â”‚   â”œâ”€â”€ permission.ts     # æƒé™é…ç½®
â”‚   â””â”€â”€ xss-white-list.ts # XSS ç™½åå•é…ç½®
â”œâ”€â”€ core/                  # æ ¸å¿ƒåŠŸèƒ½æ¨¡å—
â”‚   â”œâ”€â”€ authentication.ts # èº«ä»½éªŒè¯
â”‚   â”œâ”€â”€ index.ts          # æ ¸å¿ƒå¤„ç†é€»è¾‘
â”‚   â”œâ”€â”€ query/            # æŸ¥è¯¢å¤„ç†
â”‚   â””â”€â”€ session.ts        # ä¼šè¯ç®¡ç†
â”œâ”€â”€ db/                    # æ•°æ®åº“é…ç½®
â”‚   â””â”€â”€ index.ts          # æ•°æ®æºé…ç½®
â”œâ”€â”€ middlewares/           # ä¸­é—´ä»¶
â”‚   â”œâ”€â”€ errorHandler.ts   # é”™è¯¯å¤„ç†ä¸­é—´ä»¶
â”‚   â””â”€â”€ logger.ts         # æ—¥å¿—ä¸­é—´ä»¶
â”œâ”€â”€ models/                # æ•°æ®æ¨¡å‹
â”‚   â”œâ”€â”€ Article.ts        # æ–‡ç« æ¨¡å‹
â”‚   â”œâ”€â”€ User.ts           # ç”¨æˆ·æ¨¡å‹
â”‚   â”œâ”€â”€ Manages.ts        # ç®¡ç†å‘˜æ¨¡å‹
â”‚   â”œâ”€â”€ Channel.ts        # é¢‘é“æ¨¡å‹
â”‚   â”œâ”€â”€ Tags.ts           # æ ‡ç­¾æ¨¡å‹
â”‚   â””â”€â”€ ...               # å…¶ä»–æ¨¡å‹
â”œâ”€â”€ router/                # è·¯ç”±é…ç½®
â”‚   â””â”€â”€ index.ts          # ä¸»è·¯ç”±æ–‡ä»¶
â”œâ”€â”€ service/               # ä¸šåŠ¡æœåŠ¡å±‚
â”‚   â””â”€â”€ images/           # å›¾ç‰‡å¤„ç†æœåŠ¡
â”œâ”€â”€ types/                 # ç±»å‹å®šä¹‰
â”‚   â”œâ”€â”€ core.ts           # æ ¸å¿ƒç±»å‹
â”‚   â”œâ”€â”€ global.d.ts       # å…¨å±€ç±»å‹
â”‚   â”œâ”€â”€ koa.d.ts          # Koa æ‰©å±•ç±»å‹
â”‚   â””â”€â”€ permission.ts     # æƒé™ç±»å‹
â”œâ”€â”€ utils/                 # å·¥å…·å‡½æ•°
â”‚   â”œâ”€â”€ backup.ts         # å¤‡ä»½å·¥å…·
â”‚   â”œâ”€â”€ cache.ts          # ç¼“å­˜å·¥å…·
â”‚   â”œâ”€â”€ port.ts           # ç«¯å£æ£€æµ‹å·¥å…·
â”‚   â”œâ”€â”€ rsa.ts            # RSA åŠ å¯†å·¥å…·
â”‚   â””â”€â”€ tools.ts          # é€šç”¨å·¥å…·
â””â”€â”€ index.ts               # åº”ç”¨å…¥å£æ–‡ä»¶
```

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½

### 1. å†…å®¹ç®¡ç†ç³»ç»Ÿ
- **æ–‡ç« ç®¡ç†**: æ”¯æŒå¯Œæ–‡æœ¬ç¼–è¾‘ã€Markdown ç¼–è¾‘ã€æ–‡ç« åˆ†ç±»ã€æ ‡ç­¾ç®¡ç†
- **é¢‘é“ç®¡ç†**: å¤šçº§é¢‘é“åˆ†ç±»ã€é¢‘é“æƒé™æ§åˆ¶
- **åª’ä½“ç®¡ç†**: å›¾ç‰‡ä¸Šä¼ ã€è§†é¢‘ç®¡ç†ã€æ–‡ä»¶å­˜å‚¨
- **SEO ä¼˜åŒ–**: è‡ªå®šä¹‰æ ‡é¢˜ã€æè¿°ã€å…³é”®è¯

### 2. ç”¨æˆ·æƒé™ç³»ç»Ÿ
- **å¤šè§’è‰²ç®¡ç†**: ç®¡ç†å‘˜ã€ç¼–è¾‘ã€æ™®é€šç”¨æˆ·ç­‰è§’è‰²
- **æƒé™æ§åˆ¶**: åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ (RBAC)
- **JWT è®¤è¯**: å®‰å…¨çš„ Token è®¤è¯æœºåˆ¶
- **RSA åŠ å¯†**: å¯†ç ä¼ è¾“åŠ å¯†ä¿æŠ¤

### 3. å›¾ç‰‡å¤„ç†æœåŠ¡
- **æ™ºèƒ½ä¸Šä¼ **: æ”¯æŒå¤šç§å›¾ç‰‡æ ¼å¼ (JPEGã€PNGã€GIFã€BMPã€WEBP)
- **åŠ¨æ€ç¼©æ”¾**: å®æ—¶ç”Ÿæˆä¸åŒå°ºå¯¸çš„ç¼©ç•¥å›¾
- **æ ¼å¼è½¬æ¢**: è‡ªåŠ¨ä¼˜åŒ–å›¾ç‰‡æ ¼å¼å’Œè´¨é‡
- **ç¼“å­˜æœºåˆ¶**: ç¼©ç•¥å›¾ç¼“å­˜ï¼Œæé«˜è®¿é—®æ€§èƒ½
- **MD5 å»é‡**: é¿å…é‡å¤æ–‡ä»¶å­˜å‚¨

### 4. RESTful API
- **æ ‡å‡†åŒ–æ¥å£**: éµå¾ª REST è®¾è®¡åŸåˆ™
- **è‡ªåŠ¨è·¯ç”±**: åŸºäºæ¨¡å‹çš„è‡ªåŠ¨ CRUD æ¥å£
- **æ‰©å±•æ¥å£**: æ”¯æŒè‡ªå®šä¹‰ä¸šåŠ¡é€»è¾‘æ¥å£
- **å‚æ•°éªŒè¯**: è‡ªåŠ¨å‚æ•°æ ¡éªŒå’Œç±»å‹è½¬æ¢

## ğŸ“Š æ•°æ®æ¨¡å‹

### æ ¸å¿ƒå®ä½“
- **Article** - æ–‡ç« å®ä½“ï¼Œæ”¯æŒå¯Œæ–‡æœ¬å†…å®¹ã€åˆ†ç±»ã€æ ‡ç­¾ã€çŠ¶æ€ç®¡ç†
- **User** - ç”¨æˆ·å®ä½“ï¼ŒåŒ…å«ä¸ªäººä¿¡æ¯ã€æƒé™ã€ç¼–è¾‘å™¨åå¥½
- **Manages** - ç®¡ç†å‘˜å®ä½“ï¼Œåå°ç®¡ç†ç”¨æˆ·
- **Channel** - é¢‘é“å®ä½“ï¼Œå†…å®¹åˆ†ç±»ç®¡ç†
- **Tags** - æ ‡ç­¾å®ä½“ï¼Œå†…å®¹æ ‡ç­¾åŒ–ç®¡ç†
- **Site** - ç«™ç‚¹é…ç½®å®ä½“
- **Log** - æ“ä½œæ—¥å¿—å®ä½“
- **Flink** - å‹æƒ…é“¾æ¥å®ä½“

### æ•°æ®å…³ç³»
- æ–‡ç« ä¸é¢‘é“ï¼šå¤šå¯¹ä¸€å…³ç³»
- æ–‡ç« ä¸æ ‡ç­¾ï¼šå¤šå¯¹å¤šå…³ç³»
- ç”¨æˆ·ä¸æ–‡ç« ï¼šä¸€å¯¹å¤šå…³ç³»
- æƒé™ä¸è§’è‰²ï¼šåŸºäºè§’è‰²çš„æƒé™æ§åˆ¶

## ğŸ”§ ç¯å¢ƒé…ç½®

### ç¯å¢ƒè¦æ±‚
- Node.js >= 18.17.0
- MySQL >= 5.7
- TypeScript >= 5.8.2

### å®‰è£…ä¾èµ–
```bash
# ä½¿ç”¨ pnpm å®‰è£…ä¾èµ–
pnpm install
```

### ç¯å¢ƒå˜é‡é…ç½®
```bash
# å¤åˆ¶ç¯å¢ƒå˜é‡æ¨¡æ¿
cp .env_exp .env

# ç¼–è¾‘ç¯å¢ƒå˜é‡
vim .env
```

ç¯å¢ƒå˜é‡è¯´æ˜ï¼š
```env
DB_NAME="koa_cms"          # æ•°æ®åº“åç§°
DB_USER="root"             # æ•°æ®åº“ç”¨æˆ·å
DB_PASS="123456"           # æ•°æ®åº“å¯†ç 
DB_HOST="localhost"        # æ•°æ®åº“ä¸»æœº
DB_PORT=3306               # æ•°æ®åº“ç«¯å£
```

### å¯åŠ¨é¡¹ç›®
```bash
# å¼€å‘æ¨¡å¼
pnpm run dev

# ç”Ÿäº§æ¨¡å¼
pnpm run start
```

## ğŸŒ API æ¥å£

### åŸºç¡€ URL
```
http://localhost:3000/api/v1/
```

### æ ¸å¿ƒæ¥å£

#### è®¤è¯æ¥å£
- `POST /login` - ç”¨æˆ·ç™»å½•
- `POST /logout` - ç”¨æˆ·ç™»å‡º
- `POST /register` - ç”¨æˆ·æ³¨å†Œ
- `GET /rsa_public_key` - è·å– RSA å…¬é’¥

#### å†…å®¹ç®¡ç†
- `GET /article` - è·å–æ–‡ç« åˆ—è¡¨
- `POST /article` - åˆ›å»ºæ–‡ç« 
- `PUT /article/:id` - æ›´æ–°æ–‡ç« 
- `DELETE /article/:id` - åˆ é™¤æ–‡ç« 
- `GET /article_detail/:id` - è·å–æ–‡ç« è¯¦æƒ…

#### ç”¨æˆ·ç®¡ç†
- `GET /user` - è·å–ç”¨æˆ·åˆ—è¡¨
- `POST /user` - åˆ›å»ºç”¨æˆ·
- `PUT /user/:id` - æ›´æ–°ç”¨æˆ·ä¿¡æ¯
- `DELETE /user/:id` - åˆ é™¤ç”¨æˆ·

#### æ–‡ä»¶ä¸Šä¼ 
- `POST /upload` - æ–‡ä»¶ä¸Šä¼ 
- `POST /image` - å›¾ç‰‡ä¸Šä¼ ï¼ˆæ”¯æŒå¤„ç†ï¼‰
- `GET /image` - å›¾ç‰‡è®¿é—®ï¼ˆæ”¯æŒç¼©æ”¾ï¼‰

#### ç³»ç»Ÿç®¡ç†
- `GET /count` - è·å–ç»Ÿè®¡æ•°æ®
- `GET /backup` - æ•°æ®å¤‡ä»½
- `POST /init` - ç³»ç»Ÿåˆå§‹åŒ–

### è¯·æ±‚ç¤ºä¾‹

```bash
# ç”¨æˆ·ç™»å½•
curl -X POST http://localhost:3000/api/v1/login \
  -H "Content-Type: application/json" \
  -d '{"account":"admin","password":"encrypted_password"}'

# è·å–æ–‡ç« åˆ—è¡¨
curl -X GET http://localhost:3000/api/v1/article \
  -H "Authorization: Bearer your_jwt_token"

# åˆ›å»ºæ–‡ç« 
curl -X POST http://localhost:3000/api/v1/article \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer your_jwt_token" \
  -d '{"title":"æ–‡ç« æ ‡é¢˜","content":"æ–‡ç« å†…å®¹"}'

# ä¸Šä¼ å›¾ç‰‡
curl -X POST http://localhost:3000/api/v1/image \
  -F "image=@photo.jpg" \
  -H "Authorization: Bearer your_jwt_token"
```

## ğŸ”’ å®‰å…¨ç‰¹æ€§

### èº«ä»½éªŒè¯
- **JWT Token**: æ— çŠ¶æ€çš„èº«ä»½éªŒè¯
- **RSA åŠ å¯†**: å¯†ç ä¼ è¾“åŠ å¯†
- **Token è¿‡æœŸ**: è‡ªåŠ¨ Token è¿‡æœŸæœºåˆ¶
- **æƒé™éªŒè¯**: æ¥å£çº§æƒé™æ§åˆ¶

### æ•°æ®å®‰å…¨
- **XSS é˜²æŠ¤**: å†…å®¹è¿‡æ»¤å’Œç™½åå•æœºåˆ¶
- **SQL æ³¨å…¥é˜²æŠ¤**: TypeORM å‚æ•°åŒ–æŸ¥è¯¢
- **æ–‡ä»¶ä¸Šä¼ å®‰å…¨**: æ–‡ä»¶ç±»å‹å’Œå¤§å°é™åˆ¶
- **æ•æ„Ÿä¿¡æ¯ä¿æŠ¤**: å¯†ç åŠ ç›å­˜å‚¨

## ğŸš€ é«˜çº§ç‰¹æ€§

### æ™ºèƒ½ç«¯å£æ£€æµ‹
ç³»ç»Ÿæ”¯æŒè‡ªåŠ¨ç«¯å£æ£€æµ‹ï¼Œå½“é»˜è®¤ç«¯å£è¢«å ç”¨æ—¶ï¼Œä¼šè‡ªåŠ¨å°è¯•ä¸‹ä¸€ä¸ªå¯ç”¨ç«¯å£ï¼š

```typescript
// è‡ªåŠ¨ä» 3000 ç«¯å£å¼€å§‹æ£€æµ‹
const availablePort = await findAvailablePort(3000)
```

### å›¾ç‰‡å¤„ç†æœåŠ¡
å†…ç½®å®Œæ•´çš„å›¾ç‰‡å¤„ç†æœåŠ¡ï¼Œæ”¯æŒï¼š
- å¤šæ ¼å¼æ”¯æŒ (JPEGã€PNGã€GIFã€BMPã€WEBP)
- åŠ¨æ€ç¼©æ”¾å’Œè£å‰ª
- æ™ºèƒ½ç¼“å­˜æœºåˆ¶
- MD5 å»é‡å­˜å‚¨
- é”™è¯¯å›¾ç‰‡è¿”å›

### ç¼“å­˜ç³»ç»Ÿ
- å…¨å±€å†…å­˜ç¼“å­˜
- å›¾ç‰‡ç¼©ç•¥å›¾ç¼“å­˜
- å¯é…ç½®ç¼“å­˜ç­–ç•¥

### æ—¥å¿—ç³»ç»Ÿ
- è¯·æ±‚æ—¥å¿—è®°å½•
- é”™è¯¯æ—¥å¿—è¿½è¸ª
- æ“ä½œå®¡è®¡æ—¥å¿—

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### æ•°æ®åº“ä¼˜åŒ–
- ç´¢å¼•ä¼˜åŒ–
- æŸ¥è¯¢ä¼˜åŒ–
- è¿æ¥æ± ç®¡ç†

### é™æ€èµ„æº
- é™æ€æ–‡ä»¶æœåŠ¡
- å›¾ç‰‡ç¼“å­˜ç­–ç•¥
- CDN æ”¯æŒå‡†å¤‡

### å†…å­˜ç®¡ç†
- å…¨å±€ç¼“å­˜ç®¡ç†
- ä¸´æ—¶æ–‡ä»¶æ¸…ç†
- å†…å­˜æ³„æ¼é˜²æŠ¤

## ğŸ”§ å¼€å‘å·¥å…·

### ä»£ç è´¨é‡
- **Biome**: ä»£ç æ ¼å¼åŒ–å’Œ Lint æ£€æŸ¥
- **TypeScript**: é™æ€ç±»å‹æ£€æŸ¥
- **Nodemon**: å¼€å‘çƒ­é‡è½½

### è„šæœ¬å‘½ä»¤
```bash
pnpm run dev      # å¼€å‘æ¨¡å¼å¯åŠ¨
pnpm run start    # ç”Ÿäº§æ¨¡å¼å¯åŠ¨
pnpm run format   # ä»£ç æ ¼å¼åŒ–
pnpm run lint     # ä»£ç æ£€æŸ¥
pnpm run check    # ä»£ç æ£€æŸ¥å¹¶è‡ªåŠ¨ä¿®å¤
```

## ğŸ“ éƒ¨ç½²æŒ‡å—

### ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²
1. å®‰è£…ä¾èµ–ï¼š`pnpm install --production`
2. é…ç½®ç¯å¢ƒå˜é‡ï¼šç¼–è¾‘ `.env` æ–‡ä»¶
3. æ•°æ®åº“åˆå§‹åŒ–ï¼šè¿è¡Œæ•°æ®åº“è¿ç§»
4. å¯åŠ¨æœåŠ¡ï¼š`pnpm run start`

### Docker éƒ¨ç½²
```dockerfile
# Dockerfile ç¤ºä¾‹
FROM node:18-alpine
WORKDIR /app
COPY package*.json ./
RUN npm install --production
COPY . .
EXPOSE 3000
CMD ["npm", "start"]
```

### Nginx é…ç½®
```nginx
server {
    listen 80;
    server_name your-domain.com;
    
    location /api/ {
        proxy_pass http://localhost:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
    
    location /upfiles/ {
        alias /path/to/static/upfiles/;
        expires 1y;
    }
}
```

## ğŸ¤ è´¡çŒ®æŒ‡å—

1. Fork é¡¹ç›®
2. åˆ›å»ºç‰¹æ€§åˆ†æ”¯ï¼š`git checkout -b feature/new-feature`
3. æäº¤æ›´æ”¹ï¼š`git commit -am 'Add new feature'`
4. æ¨é€åˆ†æ”¯ï¼š`git push origin feature/new-feature`
5. æäº¤ Pull Request

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯ - æŸ¥çœ‹ [LICENSE](LICENSE) æ–‡ä»¶äº†è§£è¯¦æƒ…ã€‚

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·é€šè¿‡ä»¥ä¸‹æ–¹å¼è”ç³»ï¼š
- æäº¤ Issue
- å‘é€é‚®ä»¶
- æŠ€æœ¯äº¤æµç¾¤

---

**Koa CMS 2025** - ç°ä»£åŒ–çš„å†…å®¹ç®¡ç†ç³»ç»Ÿè§£å†³æ–¹æ¡ˆ ğŸš€